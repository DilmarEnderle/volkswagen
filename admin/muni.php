<?php

require_once "include/config.php";
require_once "include/essential.php";

$a = array(13027,13140,13167,13176,13186,13210,13245,13268,13275,13355,13386,13387,13395,13401,13452,13460,13470,13482,13486,
13516,13622,13626,13670,13700,13709,13721,13780,13791,13792,13802,13862,13864,13881,13893,13909,13922,13930,13965,13973,14018,
14022,14029,14046,14078,14085,14092,14118,14119,14122,14141,14149,14154,14157,14159,14182,14207,14210,14217,14226,14241,14254,
14255,14256,14258,14270,14278,14303,14309,14318,14321,14354,14427,14438,14440,14443,14454,14459,14466,14470,14493,14503,14509,
14510,14514,14520,14562,14573,14575,14589,14626,14628,14629,14677,14680,14701,14712,14716,14735,14765,14781,14783,14790,14811,
14835,14842,14871,14920,14937,14986,15004,15055,15072,15098,15114,15156,15173,15215,15218,15227,15237,15248,15273,15282,15284,
15285,15286,15287,15294,15295,15313,15314,15331,15352,15360,15362,15369,15404,15413,15414,15433,15437,15442,15443,15449,15450,
15451,15456,15457,15495,15511,15517,15544,15545,15548,15549,15550,15555,15560,15592,15603,15605,15614,15617,15627,15629,15630,
15631,15657,15666,15667,15678,15680,15686,15690,15713,15716,15734,15737,15742,15752,15777,15788,15813,15824,15825,15826,15829,
15837,15843,15844,15860,15862,15882,15887,15906,15910,15915,15922,15934,15935,15964,15968,15985,15993,16013,16014,16018,16030,
16034,16049,16053,16054,16055,16059,16067,16068,16073,16143,16166,16169,16172,16181,16198,16209,16222,16250,16264,16287,16291,
16312,16330,16358,16368,16391,16395,16404,16416,16434,16485,16497,16509,16517,16522,16536,16557,16562,16563,16602,16606,16656,
16765,16839,16841,16858,16863,16891,16916,16922,16930,16956,16974,16978,17001,17002,17037,17067,17111,17136,17147,12956,13151,
13329,13380,13447,13491,13514,13515,13524,13533,13537,13641,13650,13655,13675,13730,13787,13801,13819,13834,13840,13903,13983,
13984,13993,14007,14008,14033,14107,14136,14160,14209,14305,14356,14376,14420,14423,14457,14481,14521,14648,14674,15132,15271,
15301,15327,15403,15432,15434,15535,15546,15572,15659,15714,15744,15770,15781,15782,15794,15809,15873,15905,15923,15962,15963,
15974,15983,16001,16006,16011,16029,16153,16199,16221,16265,16354,16471,16601,16681,16701,16743,16760,16785,16947,16969,17014,
17036,13189,13226,13263,13271,13410,13418,13492,13545,13587,13661,13695,13752,13835,13907,13916,13969,13977,14015,14032,14117,
14200,14211,14253,14306,14374,14384,14393,14453,14467,14525,14548,14590,14595,14608,14623,14651,14658,14687,14703,14728,14756,
14772,14788,15061,15180,15257,15278,15311,15361,15412,15438,15512,15715,15724,15807,15810,15874,15875,15883,15951,15966,15975,
16009,16052,16124,16155,16238,16261,16392,16448,16574,16581,16603,16621,16624,16677,16705,16763,16787,16853,16854,16870,16887,
16903,16913,16923,16936,16960,16976,16988,17007,17018,17051,17214);

$a5menos = array();
$a5mais = array();

$db = new Mysql();
$db->query("SELECT id FROM gelic_licitacoes WHERE id IN (".implode(",",$a).")");
while ($db->nextRecord())
{
	$db->query("
SELECT 
    (SELECT SUM(IF(quantidade = 0, 1, quantidade)) FROM gelic_licitacoes_itens WHERE id_licitacao = lic.id) AS quantidade
FROM
	gelic_licitacoes AS lic
WHERE
	lic.id = ".$db->f("id")."
GROUP BY
	lic.id",1);
	if ($db->nextRecord(1))
	{
		if ($db->f("quantidade",1) > 5)
			$a5mais[] = $db->f("id");
	}
}

for ($i=0; $i<count($a); $i++)
{
	if (!in_array($a[$i], $a5mais))
		$a5menos[] = $a[$i];
}

$ap = array();

$db->query("
SELECT
	apl.id_licitacao,
	apl.id_cliente,
	apl.id_item,
	IF (clip.id_parent > 0, clip.id_parent, clip.id) AS id_parent
FROM
	gelic_licitacoes_apl AS apl
	LEFT JOIN gelic_clientes AS clip ON clip.id = apl.id_cliente
WHERE
	apl.id_licitacao IN (".implode(",",$a5menos).")
ORDER BY
	apl.id_licitacao, apl.id_item, apl.id_cliente");
while ($db->nextRecord())
{
	$dApl_id_licitacao = $db->f("id_licitacao");
	$dApl_id_cliente = $db->f("id_cliente");
	$dApl_id_item = $db->f("id_item");
	$dApl_id_parent = $db->f("id_parent");

	$db->query("SELECT cli.dn, cli.adve, cli.nome, uf.regiao FROM gelic_clientes AS cli INNER JOIN gelic_cidades AS cid ON cid.id = cli.id_cidade INNER JOIN gelic_uf AS uf ON uf.uf = cid.uf WHERE cli.id = ".$db->f("id_parent"),1);
	$db->nextRecord(1);
	$dDn = $db->f("dn",1);
	$dDn_adve = $db->f("adve",1);
	$dDn_nome = $db->f("nome",1);
	$dDn_regiao = $db->f("regiao",1);

	$db->query("SELECT cid.adve FROM gelic_licitacoes AS lic INNER JOIN gelic_cidades AS cid ON cid.id = lic.id_cidade WHERE lic.id = ".$db->f("id_licitacao"),1);
	$db->nextRecord(1);
	$dLic_adve = $db->f("adve",1);


	$simnao = utf8_decode('NÃ£o');
	if ($dDn_adve == $dLic_adve)
		$simnao = 'Sim';

	$token = $dApl_id_licitacao.':'.$dApl_id_item.':'.$dApl_id_parent;
	if (!in_array($token, $ap))
	{
		echo '<br>'.$dApl_id_licitacao.','.$dApl_id_cliente.','.$dApl_id_item.','.$dApl_id_parent.','.$dDn.','.$dDn_adve.',"'.$dDn_nome.'","'.$dDn_regiao.'",'.$dLic_adve.',"'.$simnao.'"';
		$ap[] = $token;
	}
}


?>
